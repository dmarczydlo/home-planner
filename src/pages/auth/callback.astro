---
export const prerender = false;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Completing sign in...</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .container {
        text-align: center;
        color: white;
      }
      .spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto 20px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .message {
        font-size: 18px;
        margin-bottom: 10px;
      }
      .submessage {
        font-size: 14px;
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="spinner"></div>
      <div class="message">Completing sign in...</div>
      <div class="submessage">Please wait</div>
    </div>

    <script>
      import { createSupabaseClientForAuth } from "@/lib/auth/supabaseAuth";

      async function handleCallback() {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get("code");
          const error = urlParams.get("error");
          const errorDescription = urlParams.get("error_description");

          if (error) {
            console.error("OAuth error:", error, errorDescription);
            window.location.href = `/auth/login?error=auth_failed&details=${encodeURIComponent(errorDescription || error)}`;
            return;
          }

          if (!code) {
            console.error("No authorization code received");
            window.location.href = "/auth/login?error=no_code";
            return;
          }

          const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
          const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

          const { createClient } = await import("@supabase/supabase-js");
          const supabase = createClient(supabaseUrl, supabaseKey, {
            auth: {
              storage: window.localStorage,
              autoRefreshToken: true,
              persistSession: true,
              detectSessionInUrl: false,
              flowType: "pkce",
              storageKey: `sb-${supabaseUrl.split("//")[1].split(".")[0]}-auth-token`,
            },
          });

          const { data, error: sessionError } = await supabase.auth.exchangeCodeForSession(code);

          if (sessionError || !data?.session?.user) {
            console.error("Session exchange failed:", sessionError);
            window.location.href = `/auth/login?error=session_failed&details=${encodeURIComponent(sessionError?.message || "Unknown error")}`;
            return;
          }

          const accessToken = data.session.access_token;

          window.history.replaceState(null, "", window.location.pathname);

          const response = await fetch("/api/users/me", {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (!response.ok) {
            if (response.status === 404) {
              const userMetadata = data.session.user.user_metadata;
              const createResponse = await fetch("/api/users/me", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${accessToken}`,
                },
                body: JSON.stringify({
                  id: data.session.user.id,
                  full_name: userMetadata?.full_name || userMetadata?.name || null,
                  avatar_url: userMetadata?.avatar_url || userMetadata?.picture || null,
                }),
              });

              if (!createResponse.ok) {
                console.error("User creation failed");
                window.location.href = "/auth/login?error=user_creation_failed";
                return;
              }

              window.location.href = "/onboarding/welcome";
              return;
            }

            console.error("Failed to fetch user profile");
            window.location.href = "/auth/login?error=user_not_found";
            return;
          }

          const userData = await response.json();
          const hasCompletedOnboarding = userData.families && userData.families.length > 0;

          await new Promise((resolve) => setTimeout(resolve, 100));

          window.location.replace(hasCompletedOnboarding ? "/calendar/week" : "/onboarding/welcome");
        } catch (error) {
          console.error("Unexpected error in OAuth callback:", error);
          window.location.href = "/auth/login?error=unexpected_error";
        }
      }

      handleCallback();
    </script>
  </body>
</html>

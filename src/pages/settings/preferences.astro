---
import Layout from "../../layouts/Layout.astro";
import { SettingsView } from "../../components/settings/SettingsView";

export const prerender = false;

if (!Astro.locals.user) {
  return Astro.redirect("/auth/login");
}

const userService = new (await import("../../services/UserService")).UserService(Astro.locals.repositories.user);
const result = await userService.getUserProfile(Astro.locals.user.id);

if (!result.success) {
  return Astro.redirect("/");
}

const userProfile = result.data;

if (!userProfile.families || userProfile.families.length === 0) {
  return Astro.redirect("/onboarding/welcome");
}

const primaryFamily = userProfile.families[0];
const isAdmin = primaryFamily.role === "admin";
---

<Layout title="Settings - Preferences">
  <SettingsView client:load familyId={primaryFamily.family_id} isAdmin={isAdmin} initialTab="preferences" />
</Layout>
